---
title: "Introduction to the tidyverse"
description: "R-SIG 25.03.24"
author: 
  - name: Nicklas Hafiz
  - affiliation: PhD student at the IQB, Methods team
categories: [R, tidyverse]
image: data_wrangling.jpg
number-sections: true
date: 03-25-2024
---

![](data_wrangling.jpg)[^1]

[^1]: Image by [Bing Copilot](https://www.bing.com/images/create/data-wrangling/1-65fd4161357e424ab4710052a455ae76?id=%2bsYYE%2fjAx45kPemp84oShA%3d%3d&view=detailv2&idpp=genimg&idpclose=1&thId=OIG1.63cnYyWZaAlWJaaaluAw&FORM=SYDBIC)

```{r, echo = FALSE, message = FALSE}
source(here::here("posts", "r_sig", "output_hook.R"))
```

```{r, message=FALSE}
library(tidyverse)
```

The (`tidyverse`)[https://iqb-research.github.io/IQB-Methods/posts/r_sig/24_01_26_tidyverse_intro/] provides many tools for wrangling data, from selecting, sorting or renaming columns over filtering specific rows according to complex conditions to building new columns according to values in other columns. 
Let's take a look at the most important ones. We will use the (`athletes`)[] dataset in the examples:

::: {.callout-caution icon="false" collapse="true"}
## Load the data

```{r message=FALSE}
# install.packages("tidyverse")
# install.packages("here")

library(tidyverse)
library(here)

athletes <- readRDS(file = here::here("posts", "r_sig", "raw_data", "athletes.rds"))
```
:::


## `Select()`
Selecting columns from a data.frame is pretty straight forward:

```{r, output.lines = 4}
athletes %>%
  select(Year, Sport)
```

Note how we don't have to put the columns in `""`, and how we can simply seperate them by `,`.  
`select()` becomes especially useful when combined with [selection helpers](https://dplyr.tidyverse.org/reference/select.html):

```{r, output.lines = 4}
## Select all columns starting with a Se
athletes %>%
  select(starts_with("Se"))

## Select all columns containing the letters "ea"
athletes %>%
  select(contains("ea"))

## Or, we can combine them:
athletes %>% 
  select(ends_with("t") & contains("igh"))
```

## `filter()`
We can use `filter` to subset rows according to their values in specific columns: 

```{r, output.lines = 4}
## All Volleyballers
athletes %>%
  filter(Sport == "Volleyball")

## All Judoka between 50 and 100 kg
athletes %>%
  filter(Sport == "Judo", between(Weight, 50, 100))

## All athletes with missing heigth
athletes %>%
  filter(is.na(Height))
```

Note how we can just write our conditions without connecting them with `&` (`filter()` does that automatically for us). Also, we donâ€™t have to put the column names into "", because `filter()` knows that this are column names of the athletes data frame, which makes coding a bit more pleasant. Also, missing rows are automatically removed, which makes sense in many cases!

## `pivot_...()`
To reshape data.frames from long to wide or wide to long format we can use `pivot_wider()` and `pivot_longer()`:

Let's define a simpler data.frame first: 

```{r}
inhabitants_wide <- data.frame(
  country = c("China", "India", "USA"),
  inhabitants_2021 = c(1425893465, 1407563842, NA),
  inhabitants_2022 = c(1425857720, 1420939232, 338903174)
)
inhabitants_wide
```

```{r}
inhabitants_long <- inhabitants_wide %>%
  pivot_longer(
    cols = c("inhabitants_2022", "inhabitants_2021"),
    names_to = "year",
    values_to = "inhabitants"
  )

head(inhabitants_long)
```

```{r}
inhabitants_long <- inhabitants_wide %>%
  pivot_longer(
    ## Select the columns we want to reshape:
    cols = c("inhabitants_2022", "inhabitants_2021"),
    ## Define a new column where the column names will go to:
    names_to = "year",
    ## Define a new column where the values will go to:
    values_to = "inhabitants"
  )

head(inhabitants_wide)
```

## `mutate()`
With `mutate()` we can add new columns to a data.frame or edit existing ones:

```{r, output.lines = 4}
athletes %>%
  mutate(new_column = NA)
```

### Useful helpers
Like `select()`, `mutate()` really starts to shine when helper functions are added. For example we can fill a new column according to values in other columns:
```{r}
## Build a new column indicating if this is a contact sport athlete
athletes %>%
  mutate(contact_sport = ifelse(Sport %in% c("Wrestling", "Boxing", "Judo", "Rugby", "Taekwondo", "Rugby Sevens"), 
                                yes = TRUE, 
                                no = FALSE)
         )
```

If we have to connect multiple `ifelse()` functions, it's better to use `dplyrs` `case_when()`[https://iqb-research.github.io/IQB-Methods/posts/r_sig/23_12_18_case_when/]:

```{r}
## This gets complicated pretty quickly:
athletes %>%
  mutate(judo_weightclass = ifelse(grepl("Middleweight", .$Event), 
                                  yes = "Middleweight", 
                                  no = ifelse(grepl("Half-Lightweight", .$Event), 
                                        yes = "Half-Lightweight", 
                                        no = ifelse(grepl("Lightweight", .$Event), 
                                                    yes = "Lightweight", 
                                                    no = NA)
                                        ) 
                                        )
                                  ) %>% 
  filter(Sport == "Judo")

## so do this instead:
athletes %>%
  mutate(judo_weightclass = case_when(str_detect(Event, "Middleweight") ~ "Middleweight", 
                                      str_detect(Event, "Half-Lightweight") ~ "Half-Lightweight", 
                                      str_detect(Event, "Lightweight") ~ "Lightweight")
         ) %>%
  filter(Sport == "Judo")
```





### conditional `mutate()`


### !!sim ...
